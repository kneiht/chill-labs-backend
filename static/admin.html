<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chill Labs Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    [x-cloak] {
      display: none !important;
    }

    .glass {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              850: '#151f32',
              950: '#020617',
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen selection:bg-indigo-500 selection:text-white" x-data="adminApp()">

  <!-- Login Screen -->
  <div x-show="!token"
    class="fixed inset-0 flex items-center justify-center z-50 bg-slate-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-slate-950">
    <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-800 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
      <h2
        class="text-3xl font-bold mb-2 text-center bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
        Chill Labs</h2>
      <p class="text-slate-400 text-center mb-8 text-sm">Admin Dashboard Access</p>

      <form @submit.prevent="login">
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Login (Email or
              Username)</label>
            <input x-model="loginForm.login" type="text"
              class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder-slate-600"
              placeholder="admin@example.com">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Password</label>
            <input x-model="loginForm.password" type="password"
              class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder-slate-600"
              placeholder="••••••••">
          </div>
        </div>

        <div x-show="loginError"
          class="mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm text-center"
          x-text="loginError"></div>

        <button type="submit"
          class="w-full mt-8 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-medium py-3 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-indigo-500/20">
          <span x-show="!isLoading">Sign In</span>
          <span x-show="isLoading" class="animate-pulse">Authenticating...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div x-show="token" x-cloak class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 glass border-r border-slate-800 flex flex-col z-20">
      <div class="p-6 border-b border-slate-800/50">
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Chill
          Labs</h1>
        <p class="text-xs text-slate-500 mt-1">Admin Console</p>
      </div>

      <nav class="flex-1 overflow-y-auto p-4 space-y-1">
        <template x-for="entity in entities" :key="entity.name">
          <button @click="currentEntity = entity.name; fetchItems()"
            :class="currentEntity === entity.name ? 'bg-indigo-500/10 text-indigo-400 border-indigo-500/50' : 'text-slate-400 hover:bg-slate-800/50 hover:text-slate-200 border-transparent'"
            class="w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg border transition-all group">
            <span class="w-2 h-2 rounded-full mr-3 transition-colors"
              :class="currentEntity === entity.name ? 'bg-indigo-400' : 'bg-slate-600 group-hover:bg-slate-500'"></span>
            <span x-text="entity.label"></span>
          </button>
        </template>
      </nav>

      <div class="p-4 border-t border-slate-800/50">
        <div class="flex items-center gap-3 mb-4 px-2">
          <div
            class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-xs font-bold">
            A</div>
          <div class="overflow-hidden">
            <p class="text-sm font-medium truncate" x-text="user?.display_name || 'Admin'"></p>
            <p class="text-xs text-slate-500 truncate" x-text="user?.email || 'admin@chill-labs.com'"></p>
          </div>
        </div>
        <button @click="logout"
          class="w-full flex items-center justify-center px-4 py-2 text-xs font-medium text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors">
          Sign Out
        </button>
      </div>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-950 relative">
      <!-- Background Glow -->
      <div
        class="absolute top-0 left-0 w-full h-96 bg-indigo-500/5 rounded-full blur-3xl -translate-y-1/2 pointer-events-none">
      </div>

      <!-- Header -->
      <header class="h-16 border-b border-slate-800/50 flex items-center justify-between px-8 glass z-10">
        <h2 class="text-lg font-medium text-slate-200 capitalize" x-text="currentEntityLabel"></h2>
        <div class="flex items-center gap-4">
          <button @click="fetchItems()" class="p-2 text-slate-400 hover:text-white transition-colors" title="Refresh">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
          </button>
          <button @click="openModal()"
            class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Create New</span>
          </button>
        </div>
      </header>

      <!-- Table View -->
      <div class="flex-1 overflow-auto p-8">
        <div class="glass rounded-xl border border-slate-800 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-slate-900/50 border-b border-slate-800 text-xs uppercase tracking-wider text-slate-400">
                  <template x-for="col in currentColumns" :key="col">
                    <th class="px-6 py-4 font-medium" x-text="col"></th>
                  </template>
                  <th class="px-6 py-4 text-right">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800/50">
                <template x-for="item in items" :key="item.id">
                  <tr class="hover:bg-slate-800/30 transition-colors group">
                    <template x-for="col in currentColumns" :key="col">
                      <td class="px-6 py-4 text-sm text-slate-300 whitespace-nowrap">
                        <div class="max-w-xs truncate" x-text="formatValue(item[col])"></div>
                      </td>
                    </template>
                    <td class="px-6 py-4 text-right space-x-2">
                      <button @click="openModal(item)"
                        class="text-indigo-400 hover:text-indigo-300 text-xs font-medium px-2 py-1 rounded hover:bg-indigo-500/10 transition-colors">Edit</button>
                      <button @click="deleteItem(item.id)"
                        class="text-red-400 hover:text-red-300 text-xs font-medium px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Delete</button>
                    </td>
                  </tr>
                </template>
                <tr x-show="items.length === 0">
                  <td :colspan="currentColumns.length + 1" class="px-6 py-12 text-center text-slate-500">
                    No items found.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div x-show="isModalOpen" x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" x-transition.opacity>
    <div
      class="glass w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden transform transition-all"
      @click.away="closeModal()">
      <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
        <h3 class="text-lg font-medium text-white" x-text="editingItem ? 'Edit Item' : 'Create New Item'"></h3>
        <button @click="closeModal()" class="text-slate-400 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
        <form @submit.prevent="saveItem" class="space-y-4">
          <template x-for="field in currentFields" :key="field.name">
            <div>
              <label class="block text-xs font-medium text-slate-400 mb-1 uppercase" x-text="field.label"></label>

              <template x-if="field.type === 'text' || field.type === 'email' || field.type === 'password'">
                <input :type="field.type" x-model="formData[field.name]"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-white">
              </template>

              <template x-if="field.type === 'textarea'">
                <textarea x-model="formData[field.name]" rows="3"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-white"></textarea>
              </template>

              <template x-if="field.type === 'select'">
                <select x-model="formData[field.name]"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-white">
                  <template x-for="opt in field.options" :key="opt">
                    <option :value="opt" x-text="opt"></option>
                  </template>
                </select>
              </template>
            </div>
          </template>
        </form>
      </div>
      <div class="px-6 py-4 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3">
        <button @click="closeModal()"
          class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white transition-colors">Cancel</button>
        <button @click="saveItem"
          class="px-4 py-2 text-sm font-medium bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg shadow-lg shadow-indigo-500/20 transition-all">Save
          Changes</button>
      </div>
    </div>
  </div>

  <script>
    function adminApp() {
      return {
        token: localStorage.getItem('api-token') || null,
        user: null,
        loginForm: { login: '', password: '' },
        loginError: '',
        isLoading: false,

        entities: [
          { name: 'users', label: 'Users' },
          { name: 'notes', label: 'Notes' },
          { name: 'lessons', label: 'Lessons' },
          { name: 'sentences', label: 'Sentences' },
          { name: 'vocabs', label: 'Vocabs' },
          { name: 'words', label: 'Words' },
          { name: 'word_sentences', label: 'Word Sentences' }
        ],
        currentEntity: 'users',
        items: [],

        isModalOpen: false,
        editingItem: null,
        formData: {},

        // Entity Configuration (Fields for Form & Table)
        entityConfig: {
          users: {
            columns: ['id', 'username', 'email', 'role', 'status', 'created'],
            fields: [
              { name: 'username', label: 'Username', type: 'text' },
              { name: 'email', label: 'Email', type: 'email' },
              { name: 'display_name', label: 'Display Name', type: 'text' },
              { name: 'password', label: 'Password (Leave blank to keep)', type: 'password' },
              { name: 'role', label: 'Role', type: 'select', options: ['admin', 'teacher', 'student'] },
              { name: 'status', label: 'Status', type: 'select', options: ['active', 'pending', 'suspended'] }
            ]
          },
          notes: {
            columns: ['id', 'title', 'owner_id', 'created_at'],
            fields: [
              { name: 'title', label: 'Title', type: 'text' },
              { name: 'content', label: 'Content', type: 'textarea' },
              { name: 'owner_id', label: 'Owner ID (UUID)', type: 'text' }
            ]
          },
          // Default fallback for others
          default: {
            columns: ['id', 'name', 'title', 'created_at'],
            fields: [
              { name: 'title', label: 'Title/Name', type: 'text' },
              { name: 'content', label: 'Content', type: 'textarea' }
            ]
          }
        },

        get currentEntityLabel() {
          return this.entities.find(e => e.name === this.currentEntity)?.label || this.currentEntity;
        },

        get currentConfig() {
          return this.entityConfig[this.currentEntity] || this.entityConfig.default;
        },

        get currentColumns() {
          // If we have items, try to use keys from first item if config is missing
          if (this.items.length > 0 && !this.entityConfig[this.currentEntity]) {
            return Object.keys(this.items[0]).slice(0, 6);
          }
          return this.currentConfig.columns;
        },

        get currentFields() {
          return this.currentConfig.fields;
        },

        init() {
          if (this.token) {
            this.fetchUser();
            this.fetchItems();
          }
        },

        async login() {
          this.isLoading = true;
          this.loginError = '';
          try {
            const res = await fetch('/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.loginForm)
            });
            const data = await res.json();

            if (res.ok) {
              this.token = data.data.access_token;
              this.user = data.data.user;
              localStorage.setItem('api-token', this.token);
              this.fetchItems();
            } else {
              this.loginError = data.message || 'Login failed';
            }
          } catch (e) {
            this.loginError = 'Network error occurred';
          } finally {
            this.isLoading = false;
          }
        },

        logout() {
          this.token = null;
          this.user = null;
          localStorage.removeItem('api-token');
        },

        async fetchUser() {
          try {
            const res = await fetch('/auth/me', {
              headers: { 'Authorization': `Bearer ${this.token}` }
            });
            if (res.ok) {
              const data = await res.json();
              this.user = data.data;
            } else {
              this.logout(); // Token invalid
            }
          } catch (e) {
            console.error(e);
          }
        },

        async fetchItems() {
          if (!this.token) return;
          try {
            const res = await fetch(`/admin/${this.currentEntity}`, {
              headers: { 'Authorization': `Bearer ${this.token}` }
            });
            if (res.ok) {
              const data = await res.json();
              this.items = Array.isArray(data.data) ? data.data : [];
            } else {
              if (res.status === 401) this.logout();
              alert('Failed to fetch items');
            }
          } catch (e) {
            console.error(e);
          }
        },

        openModal(item = null) {
          console.log('openModal called with:', item);
          this.editingItem = item;
          this.formData = item ? JSON.parse(JSON.stringify(item)) : {}; // Deep copy to avoid Proxy issues
          // Clear password for user edit
          if (this.currentEntity === 'users' && item) {
            this.formData.password = '';
          }
          this.isModalOpen = true;
          console.log('isModalOpen:', this.isModalOpen);
        },

        closeModal() {
          this.isModalOpen = false;
          this.editingItem = null;
          this.formData = {};
        },

        async saveItem() {
          console.log('saveItem called');
          const url = this.editingItem
            ? `/admin/${this.currentEntity}/${this.editingItem.id}`
            : `/admin/${this.currentEntity}`;

          console.log('Saving to URL:', url);
          console.log('Data:', this.formData);

          const method = this.editingItem ? 'PUT' : 'POST';

          // Clean up empty password for users
          if (this.currentEntity === 'users' && !this.formData.password) {
            delete this.formData.password;
          }

          try {
            const res = await fetch(url, {
              method,
              headers: {
                'Authorization': `Bearer ${this.token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.formData)
            });

            if (res.ok) {
              this.closeModal();
              this.fetchItems();
            } else {
              const data = await res.json();
              alert(data.message || 'Operation failed');
            }
          } catch (e) {
            alert('Network error');
          }
        },

        async deleteItem(id) {
          if (!confirm('Are you sure you want to delete this item?')) return;

          try {
            const res = await fetch(`/admin/${this.currentEntity}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${this.token}` }
            });

            if (res.ok) {
              this.fetchItems();
            } else {
              alert('Failed to delete item');
            }
          } catch (e) {
            alert('Network error');
          }
        },

        formatValue(val) {
          if (val === null || val === undefined) return '-';
          if (typeof val === 'object') return JSON.stringify(val);
          if (typeof val === 'string' && val.length > 50) return val.substring(0, 50) + '...';
          return val;
        }
      }
    }
  </script>
</body>

</html>