<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --scroll-track: #0f172a;
      --scroll-thumb: #334155;
      --scroll-thumb-hover: #475569;
      --scroll-corner: #0b1228;
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--scroll-thumb) var(--scroll-track);
    }

    /* WebKit */
    *::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    *::-webkit-scrollbar-track {
      background: var(--scroll-track);
      border-radius: 9999px;
    }

    *::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,
          rgba(51, 65, 85, 0.95),
          rgba(30, 41, 59, 0.95));
      border: 2px solid var(--scroll-track);
      border-radius: 9999px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--scroll-thumb-hover);
    }

    *::-webkit-scrollbar-corner {
      background: var(--scroll-corner);
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th {
      position: sticky;
      top: 0;
      background: #1e293b;
      z-index: 10;
    }

    .btn-primary {
      background-color: #4f46e5;
      transition: background-color 0.2s;
    }

    .btn-primary:hover {
      background-color: #4338ca;
    }

    .btn-secondary {
      background-color: #1e293b;
      border: 1px solid #334155;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: #334155;
      border-color: #475569;
    }

    .btn-danger {
      background-color: #dc2626;
      transition: background-color 0.2s;
    }

    .btn-danger:hover {
      background-color: #b91c1c;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    .tab-btn {
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .tab-btn.active {
      background-color: #4f46e5;
    }

    .truncate-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-indigo-400">üîê Admin Panel</h1>
        <div id="user-info" class="hidden flex items-center gap-3">
          <span class="text-sm text-slate-400">
            Logged in as: <span id="user-name" class="text-slate-200 font-medium"></span>
            (<span id="user-role" class="text-indigo-300"></span>)
          </span>
          <button id="btn-logout" class="btn-secondary px-4 py-2 rounded-md text-sm font-medium">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Auth Section -->
    <section id="auth-section" class="max-w-md mx-auto">
      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Admin Login</h2>
        <form id="login-form" class="grid gap-4">
          <div>
            <label class="text-xs text-slate-400 block mb-1">Email or Username</label>
            <input id="login-username" type="text" required
              class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-400 block mb-1">Password</label>
            <input id="login-password" type="password" required
              class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
          </div>
          <button type="submit" class="btn-primary px-4 py-2 rounded-md text-sm font-medium">
            Login
          </button>
        </form>
        <div id="auth-message" class="mt-4 text-sm text-center"></div>
      </div>
    </section>

    <!-- Admin Section -->
    <section id="admin-section" class="hidden">
      <!-- Tabs -->
      <div class="flex gap-2 mb-4">
        <button id="tab-users" class="tab-btn active" onclick="switchTab('users')">
          üë• Users
        </button>
        <button id="tab-notes" class="tab-btn" onclick="switchTab('notes')">
          üìù Notes
        </button>
      </div>

      <!-- Users Table -->
      <div id="users-panel" class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-lg">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between">
          <h2 class="text-xl font-semibold">Users Management</h2>
          <div class="flex gap-2">
            <button id="btn-create-user" class="btn-primary px-4 py-2 rounded-md text-sm font-medium"
              onclick="openCreateUserModal()">
              ‚ú® Create User
            </button>
            <button id="btn-refresh-users" class="btn-secondary px-4 py-2 rounded-md text-sm font-medium"
              onclick="loadUsers()">
              üîÑ Refresh
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="px-4 py-3 text-left font-medium text-slate-300">ID</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Display Name</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Email</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Username</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Role</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Created</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Actions</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="users-empty" class="p-8 text-center text-slate-400 hidden">
          No users found.
        </div>
      </div>

      <!-- Notes Table -->
      <div id="notes-panel" class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-lg hidden">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between">
          <h2 class="text-xl font-semibold">Notes Management</h2>
          <div class="flex gap-2">
            <button id="btn-create-note" class="btn-primary px-4 py-2 rounded-md text-sm font-medium"
              onclick="openCreateNoteModal()">
              ‚ú® Create Note
            </button>
            <button id="btn-refresh-notes" class="btn-secondary px-4 py-2 rounded-md text-sm font-medium"
              onclick="loadNotes()">
              üîÑ Refresh
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="px-4 py-3 text-left font-medium text-slate-300">ID</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">User ID</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Title</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Content</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Created</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Updated</th>
                <th class="px-4 py-3 text-left font-medium text-slate-300">Actions</th>
              </tr>
            </thead>
            <tbody id="notes-table-body">
              <!-- Notes will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="notes-empty" class="p-8 text-center text-slate-400 hidden">
          No notes found.
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-400">
      Admin Panel - English Coaching Platform
    </footer>
  </div>

  <!-- Create Note Modal -->
  <div id="create-note-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Create New Note</h3>
      <form id="create-note-form" class="grid gap-4">
        <div>
          <label class="text-xs text-slate-400 block mb-1">User ID</label>
          <input id="create-note-user-id" type="text" required placeholder="Enter the owner's User ID"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Title</label>
          <input id="create-note-title" type="text" required
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Content</label>
          <textarea id="create-note-content" required rows="6"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1 px-4 py-2 rounded-md text-sm font-medium">Create Note</button>
          <button type="button" onclick="closeCreateNoteModal()"
            class="btn-secondary flex-1 px-4 py-2 rounded-md text-sm font-medium">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="create-user-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Create New User</h3>
      <form id="create-user-form" class="grid gap-4">
        <div>
          <label class="text-xs text-slate-400 block mb-1">Display Name</label>
          <input id="create-user-display-name" type="text"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Email</label>
          <input id="create-user-email" type="email"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Username</label>
          <input id="create-user-username" type="text"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Password</label>
          <input id="create-user-password" type="password" required
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Role</label>
          <select id="create-user-role"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500">
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1 px-4 py-2 rounded-md text-sm font-medium">Create User</button>
          <button type="button" onclick="closeCreateUserModal()"
            class="btn-secondary flex-1 px-4 py-2 rounded-md text-sm font-medium">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="edit-user-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Edit User</h3>
      <form id="edit-user-form" class="grid gap-4">
        <input type="hidden" id="edit-user-id">
        <div>
          <label class="text-xs text-slate-400 block mb-1">Display Name</label>
          <input id="edit-user-display-name" type="text"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Email</label>
          <input id="edit-user-email" type="email"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Username</label>
          <input id="edit-user-username" type="text"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Role</label>
          <select id="edit-user-role"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500">
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1 px-4 py-2 rounded-md text-sm font-medium">
            Save Changes
          </button>
          <button type="button" onclick="closeEditUserModal()"
            class="btn-secondary flex-1 px-4 py-2 rounded-md text-sm font-medium">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Note Modal -->
  <div id="edit-note-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Edit Note</h3>
      <form id="edit-note-form" class="grid gap-4">
        <input type="hidden" id="edit-note-id">
        <div>
          <label class="text-xs text-slate-400 block mb-1">Title</label>
          <input id="edit-note-title" type="text" required
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Content</label>
          <textarea id="edit-note-content" required rows="6"
            class="w-full rounded-md bg-slate-900/70 border border-slate-800 px-3 py-2 text-sm outline-none focus:border-indigo-500"></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1 px-4 py-2 rounded-md text-sm font-medium">
            Save Changes
          </button>
          <button type="button" onclick="closeEditNoteModal()"
            class="btn-secondary flex-1 px-4 py-2 rounded-md text-sm font-medium">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = '';
    const $ = (id) => document.getElementById(id);

    let authToken = localStorage.getItem('admin-token') || '';
    let currentUser = null;

    // Utility functions
    function showMessage(message, isError = false) {
      const el = $('auth-message');
      el.textContent = message;
      el.className = `mt-4 text-sm text-center ${isError ? 'text-red-400' : 'text-green-400'}`;
    }

    function showAuthSection() {
      $('auth-section').classList.remove('hidden');
      $('admin-section').classList.add('hidden');
      $('user-info').classList.add('hidden');
    }

    function showAdminSection() {
      $('auth-section').classList.add('hidden');
      $('admin-section').classList.remove('hidden');
      $('user-info').classList.remove('hidden');
    }

    function switchTab(tab) {
      // Update tab buttons
      $('tab-users').classList.toggle('active', tab === 'users');
      $('tab-notes').classList.toggle('active', tab === 'notes');

      // Update panels
      $('users-panel').classList.toggle('hidden', tab !== 'users');
      $('notes-panel').classList.toggle('hidden', tab !== 'notes');

      // Load data
      if (tab === 'users') {
        loadUsers();
      } else if (tab === 'notes') {
        loadNotes();
      }
    }

    async function apiCall(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
      };

      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers,
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || `Request failed: ${response.status}`);
      }

      return data;
    }

    // Auth functions
    async function login(e) {
      e.preventDefault();
      try {
        const username = $('login-username').value;
        const password = $('login-password').value;

        const data = await apiCall('/auth/login', {
          method: 'POST',
          body: JSON.stringify({
            login: username,
            password: password,
          }),
        });

        authToken = data.data.access_token;
        localStorage.setItem('admin-token', authToken);
        // The login response already contains the user object.
        // We can use it directly instead of making another API call.
        currentUser = data.data.user;

        // Check if user is admin
        if (currentUser.role !== 'Admin') {
          showMessage('Access denied. Admin privileges required.', true);
          logout();
          return;
        }

        updateUserInfoHeader();
        showAdminSection();
        await loadUsers();
      } catch (error) {
        showMessage(error.message, true);
      }
    }

    async function loadCurrentUser() {
      try {
        const data = await apiCall('/auth/me');
        currentUser = data.data;
        updateUserInfoHeader();
      } catch (error) {
        console.error('Failed to load user:', error);
        logout();
      }
    }

    function logout() {
      authToken = '';
      currentUser = null;
      localStorage.removeItem('admin-token');
      showAuthSection();
    }

    function updateUserInfoHeader() {
      if (currentUser) {
        $('user-name').textContent = currentUser.display_name || currentUser.username || currentUser.email || 'User';
        $('user-role').textContent = currentUser.role || 'student';
      }
    }

    // Users management
    async function loadUsers() {
      try {
        const data = await apiCall('/users');
        const users = data.data;
        const tbody = $('users-table-body');
        const empty = $('users-empty');

        if (users.length === 0) {
          tbody.innerHTML = '';
          empty.classList.remove('hidden');
          return;
        }

        empty.classList.add('hidden');
        tbody.innerHTML = users.map(user => `
          <tr class="border-b border-slate-800 hover:bg-slate-800/50">
            <td class="px-4 py-3 text-xs text-slate-400 truncate-cell" title="${user.id}">${user.id.substring(0, 8)}...</td>
            <td class="px-4 py-3">${escapeHtml(user.display_name || '-')}</td>
            <td class="px-4 py-3">${escapeHtml(user.email || '-')}</td>
            <td class="px-4 py-3">${escapeHtml(user.username || '-')}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded text-xs ${getRoleBadgeClass(user.role)}">
                ${user.role || 'student'}
              </span>
            </td>
            <td class="px-4 py-3 text-xs text-slate-400">${new Date(user.created).toLocaleString()}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button onclick="editUser('${user.id}')" class="btn-secondary btn-sm">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="deleteUser('${user.id}')" class="btn-danger btn-sm">
                  üóëÔ∏è Delete
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load users:', error);
        alert('Failed to load users: ' + error.message);
      }
    }

    function openCreateUserModal() {
      $('create-user-form').reset();
      $('create-user-modal').classList.remove('hidden');
    }

    function closeCreateUserModal() {
      $('create-user-modal').classList.add('hidden');
    }

    async function createUser(e) {
      e.preventDefault();
      try {
        const body = {
          password: $('create-user-password').value,
          role: $('create-user-role').value,
        };

        const displayName = $('create-user-display-name').value.trim();
        const email = $('create-user-email').value.trim();
        const username = $('create-user-username').value.trim();

        if (displayName) body.display_name = displayName;
        if (email) body.email = email;
        if (username) body.username = username;

        await apiCall('/users', {
          method: 'POST',
          body: JSON.stringify(body),
        });

        closeCreateUserModal();
        await loadUsers();
        alert('User created successfully!');
      } catch (error) {
        alert('Failed to create user: ' + error.message);
      }
    }

    function getRoleBadgeClass(role) {
      switch (role) {
        case 'admin': return 'bg-red-900/50 text-red-300';
        case 'teacher': return 'bg-indigo-900/50 text-indigo-300';
        default: return 'bg-slate-700 text-slate-300';
      }
    }

    async function editUser(userId) {
      try {
        const data = await apiCall(`/users/${userId}`);
        const user = data.data;

        $('edit-user-id').value = user.id;
        $('edit-user-display-name').value = user.display_name || '';
        $('edit-user-email').value = user.email || '';
        $('edit-user-username').value = user.username || '';
        $('edit-user-role').value = user.role || 'student';

        $('edit-user-modal').classList.remove('hidden');
      } catch (error) {
        alert('Failed to load user: ' + error.message);
      }
    }

    function closeEditUserModal() {
      $('edit-user-modal').classList.add('hidden');
    }

    async function saveUser(e) {
      e.preventDefault();
      try {
        const userId = $('edit-user-id').value;
        const body = {};

        const displayName = $('edit-user-display-name').value.trim();
        const email = $('edit-user-email').value.trim();
        const username = $('edit-user-username').value.trim();
        const role = $('edit-user-role').value;

        if (displayName) body.display_name = displayName;
        if (email) body.email = email;
        if (username) body.username = username;
        if (role) body.role = role;

        await apiCall(`/users/${userId}`, {
          method: 'PUT',
          body: JSON.stringify(body),
        });

        closeEditUserModal();
        await loadUsers();
        alert('User updated successfully!');
      } catch (error) {
        alert('Failed to update user: ' + error.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }

      try {
        await apiCall(`/users/${userId}`, {
          method: 'DELETE',
        });
        await loadUsers();
        alert('User deleted successfully!');
      } catch (error) {
        alert('Failed to delete user: ' + error.message);
      }
    }

    function openCreateNoteModal() {
      $('create-note-form').reset();
      $('create-note-modal').classList.remove('hidden');
    }

    function closeCreateNoteModal() {
      $('create-note-modal').classList.add('hidden');
    }

    async function createNote(e) {
      e.preventDefault();
      try {
        const body = {
          user_id: $('create-note-user-id').value.trim(),
          title: $('create-note-title').value.trim(),
          content: $('create-note-content').value.trim(),
        };

        await apiCall('/notes', {
          method: 'POST',
          body: JSON.stringify(body),
        });

        closeCreateNoteModal();
        await loadNotes();
        alert('Note created successfully!');
      } catch (error) {
        alert('Failed to create note: ' + error.message);
      }
    }

    // Notes management
    async function loadNotes() {
      try {
        const data = await apiCall('/notes');
        const notes = data.data;
        const tbody = $('notes-table-body');
        const empty = $('notes-empty');

        if (notes.length === 0) {
          tbody.innerHTML = '';
          empty.classList.remove('hidden');
          return;
        }

        empty.classList.add('hidden');
        tbody.innerHTML = notes.map(note => `
          <tr class="border-b border-slate-800 hover:bg-slate-800/50">
            <td class="px-4 py-3 text-xs text-slate-400 truncate-cell" title="${note.id}">${note.id.substring(0, 8)}...</td>
            <td class="px-4 py-3 text-xs text-slate-400 truncate-cell" title="${note.user_id}">${note.user_id.substring(0, 8)}...</td>
            <td class="px-4 py-3 truncate-cell" title="${escapeHtml(note.title)}">${escapeHtml(note.title)}</td>
            <td class="px-4 py-3 truncate-cell" title="${escapeHtml(note.content)}">${escapeHtml(note.content.substring(0, 50))}${note.content.length > 50 ? '...' : ''}</td>
            <td class="px-4 py-3 text-xs text-slate-400">${new Date(note.created).toLocaleString()}</td>
            <td class="px-4 py-3 text-xs text-slate-400">${new Date(note.updated).toLocaleString()}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button onclick="editNote('${note.id}')" class="btn-secondary btn-sm">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="deleteNote('${note.id}')" class="btn-danger btn-sm">
                  üóëÔ∏è Delete
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load notes:', error);
        alert('Failed to load notes: ' + error.message);
      }
    }

    async function editNote(noteId) {
      try {
        const data = await apiCall(`/notes/${noteId}`);
        const note = data.data;

        $('edit-note-id').value = note.id;
        $('edit-note-title').value = note.title;
        $('edit-note-content').value = note.content;

        $('edit-note-modal').classList.remove('hidden');
      } catch (error) {
        alert('Failed to load note: ' + error.message);
      }
    }

    function closeEditNoteModal() {
      $('edit-note-modal').classList.add('hidden');
    }

    async function saveNote(e) {
      e.preventDefault();
      try {
        const noteId = $('edit-note-id').value;
        const body = {
          title: $('edit-note-title').value,
          content: $('edit-note-content').value,
        };

        await apiCall(`/notes/${noteId}`, {
          method: 'PUT',
          body: JSON.stringify(body),
        });

        closeEditNoteModal();
        await loadNotes();
        alert('Note updated successfully!');
      } catch (error) {
        alert('Failed to update note: ' + error.message);
      }
    }

    async function deleteNote(noteId) {
      if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
      }

      try {
        await apiCall(`/notes/${noteId}`, {
          method: 'DELETE',
        });
        await loadNotes();
        alert('Note deleted successfully!');
      } catch (error) {
        alert('Failed to delete note: ' + error.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    $('login-form').addEventListener('submit', login);
    $('btn-logout').addEventListener('click', logout);
    $('create-user-form').addEventListener('submit', createUser);
    $('create-note-form').addEventListener('submit', createNote);
    $('edit-user-form').addEventListener('submit', saveUser);
    $('edit-note-form').addEventListener('submit', saveNote);

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      if (authToken) {
        try {
          await loadCurrentUser();
          if (currentUser && currentUser.role === 'admin') {
            showAdminSection();
            await loadUsers();
          } else {
            logout();
          }
        } catch (error) {
          logout();
        }
      }
    });
  </script>
</body>

</html>